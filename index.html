<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>تطبيق دراسات</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#1976d2">
  <meta name="description" content="تطبيق لإدارة الدراسات والبيانات">
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAF0WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNy4yLWMwMDAgNzkuMWI2NWE3OWI0LCAyMDIyLzA2LzEzLTIyOjAxOjAxICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjQuMCAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjQtMDItMTlUMTU6NDc6NDctMDg6MDAiIHhtcDpNZXRhZGF0YURhdGU9IjIwMjQtMDItMTlUMTU6NDc6NDctMDg6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDI0LTAyLTE5VDE1OjQ3OjQ3LTA4OjAwIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjY5ZDEzZjM5LTU2ZDAtNDZiZC1hMzA2LTNmYzM5ZjM5ZjM5ZiIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjY5ZDEzZjM5LTU2ZDAtNDZiZC1hMzA2LTNmYzM5ZjM5ZjM5ZiIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjY5ZDEzZjM5LTU2ZDAtNDZiZC1hMzA2LTNmYzM5ZjM5ZjM5ZiIgZGM6Zm9ybWF0PSJpbWFnZS9wbmciIHBob3Rvc2hvcDpDb2xvck1vZGU9IjMiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjY5ZDEzZjM5LTU2ZDAtNDZiZC1hMzA2LTNmYzM5ZjM5ZjM5ZiIgc3RFdnQ6d2hlbj0iMjAyNC0wMi0xOVQxNTo0Nzo0Ny0wODowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIDI0LjAgKE1hY2ludG9zaCkiLz4gPC9yZGY6U2VxPiA8L3htcE1NOkhpc3Rvcnk+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+">
  <style>
    body { 
      font-family: sans-serif; 
      background: #f2f2f2; 
      padding: 10px;
      max-width: 100%;
      overflow-x: hidden;
    }
    nav { text-align: center; margin-bottom: 10px; }
    nav button {
      padding: 10px 20px; margin: 5px; background: #1976d2; color: white;
      border: none; border-radius: 5px; font-weight: bold;
    }
    .page { 
      display: none; 
      background: white; 
      padding: 10px; 
      border-radius: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .page.active { display: block; }
    input, textarea {
      width: 100%; padding: 8px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px;
    }
    button[type="submit"], .update-btn {
      background: #4caf50; color: white; border: none; padding: 10px;
      margin-top: 10px; width: 100%; border-radius: 5px;
    }
    .entries { margin-top: 15px; }
    .entry {
      background: #f9f9f9;
      padding: 10px;
      border: 1px solid #ccc;
      margin-top: 10px;
      border-radius: 5px;
      width: 100%;
      box-sizing: border-box;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .entry p {
      word-wrap: break-word;
      white-space: pre-wrap;
      margin: 0;
      line-height: 1.4;
      padding: 2px 0;
      width: 100%;
      box-sizing: border-box;
      overflow-wrap: break-word;
      word-break: break-word;
    }
    .entry button {
      margin: 5px;
      white-space: nowrap;
    }
    .entry .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-top: 10px;
    }
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 25px;
      border-radius: 5px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      animation: slideIn 0.5s, fadeOut 0.5s 2.5s;
      animation-fill-mode: forwards;
    }
    .success { background-color: #4caf50; }
    .error { background-color: #f44336; }
    .warning { background-color: #ff9800; }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 500px;
      text-align: center;
      direction: rtl;
    }
    .modal-buttons {
      margin-top: 20px;
      display: flex;
      justify-content: center;
      gap: 10px;
    }
    .modal-buttons button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    .delete-confirm {
      background-color: #f44336;
      color: white;
    }
    .delete-cancel {
      background-color: #9e9e9e;
      color: white;
    }
    @media (max-width: 600px) {
      body {
        padding: 5px;
      }
      .page {
        padding: 8px;
      }
      .entry {
        padding: 8px;
      }
      nav button {
        padding: 8px 15px;
        font-size: 14px;
      }
      .entry button {
        padding: 8px 15px;
        font-size: 14px;
      }
    }
    .export-btn, .import-btn {
      background: #ff9800 !important;
      margin-top: 10px;
      margin-right: 5px;
    }
    .import-btn {
      background: #2196f3 !important;
    }
    #fileInput {
      display: none;
    }
  </style>
</head>
<body>
  <nav>
    <button onclick="showPage('page1')">دراسات شاملة</button>
    <button onclick="showPage('page2')">بيانات عناصر القسم</button>
    <button onclick="showPage('page3')">دراسات سكنية</button>
    <button onclick="showPage('page4')">الحدث اليومي</button>
  </nav>

  <!-- الصفحات -->
  <section id="page1" class="page active">
    <h2>دراسات شاملة</h2>
    <input type="text" placeholder="بحث..." onkeyup="search(this, 'data1')">
    <div id="form1Inputs"></div>
    <div class="import-export-buttons">
      <button class="export-btn" onclick="exportToCSV('data1')">تصدير CSV</button>
      <button class="import-btn" onclick="document.getElementById('fileInput1').click()">استيراد CSV</button>
      <button class="telegram-btn" onclick="sendAllToTelegram('data1')" style="background: #0088cc !important; color: white;">إرسال الكل إلى التلجرام</button>
      <input type="file" id="fileInput1" accept=".csv" onchange="importCSV(event, 'data1')" style="display: none;">
    </div>
    <div id="data1" class="entries"></div>
  </section>

  <section id="page2" class="page">
    <h2>بيانات عناصر القسم</h2>
    <input type="text" placeholder="بحث..." onkeyup="search(this, 'data2')">
    <div id="form2Inputs"></div>
    <div class="import-export-buttons">
      <button class="export-btn" onclick="exportToCSV('data2')">تصدير CSV</button>
      <button class="import-btn" onclick="document.getElementById('fileInput2').click()">استيراد CSV</button>
      <button class="telegram-btn" onclick="sendAllToTelegram('data2')" style="background: #0088cc !important; color: white;">إرسال الكل إلى التلجرام</button>
      <input type="file" id="fileInput2" accept=".csv" onchange="importCSV(event, 'data2')" style="display: none;">
    </div>
    <div id="data2" class="entries"></div>
  </section>

  <section id="page3" class="page">
    <h2>دراسات سكنية</h2>
    <input type="text" placeholder="بحث..." onkeyup="search(this, 'data3')">
    <div id="form3Inputs"></div>
    <div class="import-export-buttons">
      <button class="export-btn" onclick="exportToCSV('data3')">تصدير CSV</button>
      <button class="import-btn" onclick="document.getElementById('fileInput3').click()">استيراد CSV</button>
      <button class="telegram-btn" onclick="sendAllToTelegram('data3')" style="background: #0088cc !important; color: white;">إرسال الكل إلى التلجرام</button>
      <input type="file" id="fileInput3" accept=".csv" onchange="importCSV(event, 'data3')" style="display: none;">
    </div>
    <div id="data3" class="entries"></div>
  </section>

  <section id="page4" class="page">
    <h2>الحدث اليومي</h2>
    <input type="text" placeholder="بحث..." onkeyup="search(this, 'data4')">
    <div id="form4Inputs"></div>
    <div class="import-export-buttons">
      <button class="export-btn" onclick="exportToCSV('data4')">تصدير CSV</button>
      <button class="import-btn" onclick="document.getElementById('fileInput4').click()">استيراد CSV</button>
      <button class="telegram-btn" onclick="sendAllToTelegram('data4')" style="background: #0088cc !important; color: white;">إرسال الكل إلى التلجرام</button>
      <input type="file" id="fileInput4" accept=".csv" onchange="importCSV(event, 'data4')" style="display: none;">
    </div>
    <div id="data4" class="entries"></div>
  </section>

  <script>
    // تعريف الحقول لكل صفحة
    const fields = {
      data1: ["الاسم", "النسبة", "اسم الاب", "اسم الأم", "مكان وتاريخ الولادة", "الاسم الحركي", "الأوصاف والعلامات المميزة", "الوضع العائلي", "عدد الأولاد", "اسم الزوجة", "منطقة الزوجة", "العمل قبل الثورة", "العمل الحالي", "المؤهل العلمي", "الوضع المادي", "الناحية الأخلاقية", "الخدمة الإلزامية", "الاختصاص", "السكن السابق", "السكن الحالي", "الفصائل التي انضم إليها", "موقفه من الثورة", "الدول التي سافر إليها", "أقاربه مع النظام", "أقاربه مع تنظيم الدولة", "أقاربه مع الفصائل", "أقاربهم الذين سجنهم الجهاز الأمني", "الالتزام الديني", "التوجه الفكري", "الأهلية القيادية", "قوة الشخصية", "مدى التأثر بالآخرين", "مدى التأثير بالمجتمع", "طبيعة العلاقة مع الآخرين", "القدرة على المحاورة والإقناع", "أهم الصفات الشخصية", "هل سجن سابقاً", "وسيلة التواصل إن وجد", "تفاصيل أخرى", "موجز عن حياته"],
      data2: ["الاسم الثلاثي", "اسم الأم", "المواليد", "السكن", "رقم الهاتف"],
      data3: ["رمز البناء", "اسم الساكن الثلاثي", "مواليد الساكن", "اسم زوجة الساكن", "أولاد الساكن", "أعمام الساكن", "أخوال الساكن", "معلومات أخرى"],
      data4: ["تقرير الأحداث اليومية في مديرية أمن درعا قسم المدينة الغربي\nليوم", "سجل الأحداث الأمنية", "سجل الأحداث العسكرية", "سجل الأحداث السياسية", "سجل أحداث الشارع", "سجل الأحداث الخدمية", "سجل المواضيع الأخرى"]
    };

    let editTarget = null;

    // تعريف manifest.json
    const manifest = {
      "name": "تطبيق دراسات",
      "short_name": "دراسات",
      "description": "تطبيق لإدارة الدراسات والبيانات",
      "start_url": "/",
      "display": "standalone",
      "background_color": "#ffffff",
      "theme_color": "#1976d2",
      "orientation": "portrait",
      "icons": [
        {
          "src": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMAAAADACAYAAABS3GwHAAAACXBIWXMAAAsTAAALEwEAmpwYAAAF0WlUWHRYTUw6Y29tLmFkb2JlLnhtcAAAAAAAPD94cGFja2V0IGJlZ2luPSLvu78iIGlkPSJXNU0wTXBDZWhpSHpyZVN6TlRjemtjOWQiPz4gPHg6eG1wbWV0YSB4bWxuczp4PSJhZG9iZTpuczptZXRhLyIgeDp4bXB0az0iQWRvYmUgWE1QIENvcmUgNy4yLWMwMDAgNzkuMWI2NWE3OWI0LCAyMDIyLzA2LzEzLTIyOjAxOjAxICAgICAgICAiPiA8cmRmOlJERiB4bWxuczpyZGY9Imh0dHA6Ly93d3cudzMub3JnLzE5OTkvMDIvMjItcmRmLXN5bnRheC1ucyMiPiA8cmRmOkRlc2NyaXB0aW9uIHJkZjphYm91dD0iIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtbG5zOnhtcE1NPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvbW0vIiB4bWxuczpzdEV2dD0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL3NUeXBlL1Jlc291cmNlRXZlbnQjIiB4bWxuczpkYz0iaHR0cDovL3B1cmwub3JnL2RjL2VsZW1lbnRzLzEuMS8iIHhtbG5zOnBob3Rvc2hvcD0iaHR0cDovL25zLmFkb2JlLmNvbS9waG90b3Nob3AvMS4wLyIgeG1wOkNyZWF0b3JUb29sPSJBZG9iZSBQaG90b3Nob3AgMjQuMCAoTWFjaW50b3NoKSIgeG1wOkNyZWF0ZURhdGU9IjIwMjQtMDItMTlUMTU6NDc6NDctMDg6MDAiIHhtcDpNZXRhZGF0YURhdGU9IjIwMjQtMDItMTlUMTU6NDc6NDctMDg6MDAiIHhtcDpNb2RpZnlEYXRlPSIyMDI0LTAyLTE5VDE1OjQ3OjQ3LTA4OjAwIiB4bXBNTTpJbnN0YW5jZUlEPSJ4bXAuaWlkOjY5ZDEzZjM5LTU2ZDAtNDZiZC1hMzA2LTNmYzM5ZjM5ZjM5ZiIgeG1wTU06RG9jdW1lbnRJRD0iYWRvYmU6ZG9jaWQ6cGhvdG9zaG9wOjY5ZDEzZjM5LTU2ZDAtNDZiZC1hMzA2LTNmYzM5ZjM5ZjM5ZiIgeG1wTU06T3JpZ2luYWxEb2N1bWVudElEPSJ4bXAuZGlkOjY5ZDEzZjM5LTU2ZDAtNDZiZC1hMzA2LTNmYzM5ZjM5ZjM5ZiIgZGM6Zm9ybWF0PSJpbWFnZS9wbmciIHBob3Rvc2hvcDpDb2xvck1vZGU9IjMiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJjcmVhdGVkIiBzdEV2dDppbnN0YW5jZUlEPSJ4bXAuaWlkOjY5ZDEzZjM5LTU2ZDAtNDZiZC1hMzA2LTNmYzM5ZjM5ZjM5ZiIgc3RFdnQ6d2hlbj0iMjAyNC0wMi0xOVQxNTo0Nzo0Ny0wODowMCIgc3RFdnQ6c29mdHdhcmVBZ2VudD0iQWRvYmUgUGhvdG9zaG9wIDI0LjAgKE1hY2ludG9zaCkiLz4gPC9yZGY6U2VxPiA8L3htcE1NOkhpc3Rvcnk+IDwvcmRmOkRlc2NyaXB0aW9uPiA8L3JkZjpSREY+IDwveDp4bXBtZXRhPiA8P3hwYWNrZXQgZW5kPSJyIj8+",
          "sizes": "192x192",
          "type": "image/png"
        }
      ],
      "permissions": [
        "storage",
        "unlimitedStorage",
        "fileSystem"
      ]
    };

    // تعريف service worker
    const swContent = `
      const CACHE_NAME = 'studies-app-v1';
      const urlsToCache = [
        '/',
        '/index.html'
      ];

      self.addEventListener('install', event => {
        event.waitUntil(
          caches.open(CACHE_NAME)
            .then(cache => {
              return cache.addAll(urlsToCache);
            })
        );
      });

      self.addEventListener('fetch', event => {
        event.respondWith(
          caches.match(event.request)
            .then(response => {
              if (response) {
                return response;
              }
              return fetch(event.request);
            })
        );
      });

      self.addEventListener('activate', event => {
        event.waitUntil(
          caches.keys().then(cacheNames => {
            return Promise.all(
              cacheNames.map(cacheName => {
                if (cacheName !== CACHE_NAME) {
                  return caches.delete(cacheName);
                }
              })
            );
          })
        );
      });
    `;

    // تسجيل Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        const blob = new Blob([swContent], { type: 'application/javascript' });
        const swUrl = URL.createObjectURL(blob);
        navigator.serviceWorker.register(swUrl)
          .then(registration => {
            console.log('ServiceWorker registration successful');
          })
          .catch(err => {
            console.log('ServiceWorker registration failed: ', err);
          });
      });
    }

    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    const TELEGRAM_BOT_TOKEN = '7920270644:AAEJywWkkWIbcDgEAhiNpYzEDFUixAbQyBU';
    const TELEGRAM_CHAT_ID = '-4936434596';

    async function sendToTelegram(entry) {
      try {
        const text = Array.from(entry.querySelectorAll('p'))
          .map(p => p.innerText)
          .join('\n');
        
        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: text,
            parse_mode: 'HTML'
          })
        });

        if (response.ok) {
          showNotification('تم إرسال البيانات إلى التلجرام بنجاح');
        } else {
          throw new Error('فشل في إرسال البيانات');
        }
      } catch (error) {
        console.error('خطأ في إرسال البيانات إلى التلجرام:', error);
        showNotification('حدث خطأ في إرسال البيانات إلى التلجرام', 'error');
      }
    }

    async function sendAllToTelegram(containerId) {
      try {
        const entries = document.querySelectorAll(`#${containerId} .entry`);
        if (entries.length === 0) {
          showNotification('لا توجد بيانات للإرسال', 'warning');
          return;
        }

        let allText = '';
        entries.forEach((entry, index) => {
          const entryText = Array.from(entry.querySelectorAll('p'))
            .map(p => p.innerText)
            .join('\n');
          allText += `\n=== سجل ${index + 1} ===\n${entryText}\n`;
        });

        const url = `https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`;
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            chat_id: TELEGRAM_CHAT_ID,
            text: allText,
            parse_mode: 'HTML'
          })
        });

        if (response.ok) {
          showNotification(`تم إرسال ${entries.length} سجل إلى التلجرام بنجاح`);
        } else {
          throw new Error('فشل في إرسال البيانات');
        }
      } catch (error) {
        console.error('خطأ في إرسال البيانات إلى التلجرام:', error);
        showNotification('حدث خطأ في إرسال البيانات إلى التلجرام', 'error');
      }
    }

    function createInputs(containerId) {
      const container = document.getElementById('form' + containerId.charAt(4) + 'Inputs');
      container.innerHTML = '';
      
      // إنشاء النموذج
      const form = document.createElement('form');
      form.onsubmit = (e) => submitForm(e, containerId);
      
      // إنشاء حاوية للحقول
      const inputsContainer = document.createElement('div');
      inputsContainer.className = 'inputs-container';
      
      // إضافة الحقول
      fields[containerId].forEach(f => {
        if (f === "تفاصيل أخرى" || f === "موجز عن حياته" || f === "معلومات أخرى" || 
            f === "سجل الأحداث الأمنية" || f === "سجل الأحداث العسكرية" || 
            f === "سجل الأحداث السياسية" || f === "سجل أحداث الشارع" || 
            f === "سجل الأحداث الخدمية" || f === "سجل المواضيع الأخرى") {
          inputsContainer.innerHTML += `<textarea name="${f}" placeholder="${f}" rows="4"></textarea>`;
        } else if (f.startsWith("تقرير الأحداث اليومية")) {
          inputsContainer.innerHTML += `<div style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
            <p style="margin: 0; font-weight: bold; text-align: center;">${f.split('\n')[0]}</p>
            <input type="text" name="${f}" placeholder="${f.split('\n')[1]}" style="margin-top: 5px;">
          </div>`;
        } else {
          inputsContainer.innerHTML += `<input type="text" name="${f}" placeholder="${f}">`;
        }
      });
      
      // إضافة الأزرار
      const buttonsContainer = document.createElement('div');
      buttonsContainer.className = 'form-buttons';
      buttonsContainer.innerHTML = `
        <button type="submit">إضافة</button>
        <button type="button" class="update-btn" onclick="updateEntry('${containerId}')" style="display:none">تحديث</button>
      `;
      
      // تجميع النموذج
      form.appendChild(inputsContainer);
      form.appendChild(buttonsContainer);
      container.appendChild(form);
    }

    function saveToStorage(containerId) {
      const entries = [];
      document.querySelectorAll(`#${containerId} .entry`).forEach(entry => {
        const data = {};
        entry.querySelectorAll('p').forEach(p => {
          const [key, ...rest] = p.innerText.split(':');
          data[key.trim()] = rest.join(':').trim();
        });
        entries.push(data);
      });
      localStorage.setItem(containerId, JSON.stringify(entries));
    }

    function loadFromStorage(containerId) {
      const data = JSON.parse(localStorage.getItem(containerId) || "[]");
      data.forEach((d, index) => {
        const entry = document.createElement('div');
        entry.className = 'entry';
        entry.id = `${containerId}_entry_${index}`;
        for (let key in d) {
          const p = document.createElement('p');
          if (containerId === 'data4') {
            if (key === 'تقرير الأحداث اليومية في مديرية أمن درعا قسم المدينة الغربي\nليوم') {
              p.innerHTML = `<b>${key.split('\n')[0]}</b><br><b>${key.split('\n')[1]}</b> ${d[key]}`;
            } else {
              p.innerHTML = `<b>${key}:</b><br>${d[key]}`;
            }
          } else {
            p.innerHTML = `<b>${key}:</b> ${d[key]}`;
          }
          entry.appendChild(p);
        }
        const controls = document.createElement('div');
        controls.className = 'controls';
        controls.innerHTML = `
          <button type="button" onclick="editEntry(this, '${containerId}')">تعديل</button>
          <button type="button" onclick="showDeleteConfirmation(this.closest('.entry'), '${containerId}')">حذف</button>
          <button type="button" onclick="copyEntry(this.closest('.entry'))">نسخ</button>
          <button type="button" onclick="sendToTelegram(this.closest('.entry'))" style="background: #0088cc !important;">إرسال تلجرام</button>
        `;
        entry.appendChild(controls);
        document.getElementById(containerId).appendChild(entry);
      });
    }

    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    function showDeleteConfirmation(entry, containerId) {
      const modal = document.createElement('div');
      modal.className = 'modal';
      modal.style.display = 'flex';
      
      modal.innerHTML = `
        <div class="modal-content">
          <h3 style="color: #f44336; margin-bottom: 15px;">⚠️ تحذير: حذف البيانات</h3>
          <p>هل أنت متأكد من حذف هذه البيانات؟</p>
          <p style="color: #666; font-size: 0.9em; margin-top: 10px;">لا يمكن التراجع عن هذه العملية بعد الحذف</p>
          <div class="modal-buttons">
            <button class="delete-confirm" onclick="deleteEntry('${containerId}', '${entry.id}')">نعم، احذف</button>
            <button class="delete-cancel" onclick="this.closest('.modal').remove()">إلغاء</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    }

    function deleteEntry(containerId, entryId) {
      const entry = document.getElementById(entryId);
      if (entry) {
        entry.remove();
        saveToStorage(containerId);
        showNotification('تم حذف البيانات بنجاح');
      }
      // إزالة نافذة التأكيد
      const modal = document.querySelector('.modal');
      if (modal) {
        modal.remove();
      }
    }

    function editEntry(btn, containerId) {
      try {
        // الحصول على العنصر المراد تعديله
        const entry = btn.closest('.entry');
        if (!entry) {
          showNotification('لم يتم العثور على العنصر المراد تعديله', 'error');
          return;
        }

        // الحصول على النموذج
        const form = document.querySelector(`#form${containerId.charAt(4)}Inputs form`);
        if (!form) {
          showNotification('لم يتم العثور على النموذج', 'error');
          return;
        }

        // الحصول على الأزرار
        const updateBtn = form.querySelector('.update-btn');
        const submitBtn = form.querySelector('button[type="submit"]');
        if (!updateBtn || !submitBtn) {
          showNotification('لم يتم العثور على أزرار التحديث', 'error');
          return;
        }

        // مسح النموذج
        form.reset();

        // جمع البيانات من العنصر
        const data = {};
        entry.querySelectorAll('p').forEach(p => {
          const text = p.innerText;
          const colonIndex = text.indexOf(':');
          if (colonIndex !== -1) {
            const key = text.substring(0, colonIndex).trim();
            const value = text.substring(colonIndex + 1).trim();
            data[key] = value;
          }
        });

        // ملء النموذج بالبيانات
        Object.keys(data).forEach(key => {
          const input = form.querySelector(`[name="${key}"]`);
          if (input) {
            if (input.tagName === 'TEXTAREA') {
              input.value = data[key];
            } else {
              input.value = data[key];
            }
          }
        });

        // تحديث حالة الأزرار
        editTarget = entry;
        updateBtn.style.display = 'block';
        submitBtn.style.display = 'none';

        // التمرير إلى النموذج
        form.scrollIntoView({ behavior: 'smooth' });

        showNotification('تم تحميل البيانات للتعديل');
      } catch (error) {
        console.error('خطأ في تحميل البيانات للتعديل:', error);
        showNotification('حدث خطأ في تحميل البيانات للتعديل', 'error');
      }
    }

    function submitForm(e, containerId) {
      e.preventDefault();
      const form = e.target;
      const formData = new FormData(form);
      const entry = document.createElement('div');
      entry.className = 'entry';
      entry.id = `${containerId}_entry_${Date.now()}`;

      for (let [key, value] of formData.entries()) {
        const p = document.createElement('p');
        if (containerId === 'data4') {
          if (key === 'تقرير الأحداث اليومية في مديرية أمن درعا قسم المدينة الغربي\nليوم') {
            p.innerHTML = `<b>${key.split('\n')[0]}</b><br><b>${key.split('\n')[1]}</b> ${value}`;
          } else {
            p.innerHTML = `<b>${key}:</b><br>${value}`;
          }
        } else {
          p.innerHTML = `<b>${key}:</b> ${value}`;
        }
        entry.appendChild(p);
      }

      const controls = document.createElement('div');
      controls.className = 'controls';
      controls.innerHTML = `
        <button type="button" onclick="editEntry(this, '${containerId}')">تعديل</button>
        <button type="button" onclick="showDeleteConfirmation(this.closest('.entry'), '${containerId}')">حذف</button>
        <button type="button" onclick="copyEntry(this.closest('.entry'))">نسخ</button>
        <button type="button" onclick="sendToTelegram(this.closest('.entry'))" style="background: #0088cc !important;">إرسال تلجرام</button>
      `;
      entry.appendChild(controls);
      document.getElementById(containerId).appendChild(entry);
      form.reset();
      saveToStorage(containerId);
      showNotification('تم إضافة البيانات بنجاح');
    }

    function copyEntry(entry) {
      const text = Array.from(entry.querySelectorAll('p'))
        .map(p => p.innerText)
        .join('\n');
      navigator.clipboard.writeText(text);
      showNotification('تم نسخ البيانات بنجاح');
    }

    function updateEntry(containerId) {
      try {
        if (!editTarget) {
          showNotification('لم يتم تحديد عنصر للتعديل', 'error');
          return;
        }

        const form = document.querySelector(`#form${containerId.charAt(4)}Inputs form`);
        if (!form) {
          showNotification('لم يتم العثور على النموذج', 'error');
          return;
        }

        const updateBtn = form.querySelector('.update-btn');
        const submitBtn = form.querySelector('button[type="submit"]');
        if (!updateBtn || !submitBtn) {
          showNotification('لم يتم العثور على أزرار التحديث', 'error');
          return;
        }

        // مسح محتوى العنصر القديم
        editTarget.innerHTML = '';

        // إضافة البيانات الجديدة
        const formData = new FormData(form);
        for (let [key, value] of formData.entries()) {
          const p = document.createElement('p');
          if (containerId === 'data4') {
            if (key === 'تقرير الأحداث اليومية في مديرية أمن درعا قسم المدينة الغربي\nليوم') {
              p.innerHTML = `<b>${key.split('\n')[0]}</b><br><b>${key.split('\n')[1]}</b> ${value}`;
            } else {
              p.innerHTML = `<b>${key}:</b><br>${value}`;
            }
          } else {
            p.innerHTML = `<b>${key}:</b> ${value}`;
          }
          editTarget.appendChild(p);
        }

        // إضافة أزرار التحكم
        const controls = document.createElement('div');
        controls.className = 'controls';
        controls.innerHTML = `
          <button type="button" onclick="editEntry(this, '${containerId}')">تعديل</button>
          <button type="button" onclick="showDeleteConfirmation(this.closest('.entry'), '${containerId}')">حذف</button>
          <button type="button" onclick="copyEntry(this.closest('.entry'))">نسخ</button>
          <button type="button" onclick="sendToTelegram(this.closest('.entry'))" style="background: #0088cc !important;">إرسال تلجرام</button>
        `;
        editTarget.appendChild(controls);

        // إعادة تعيين النموذج وحالة الأزرار
        form.reset();
        editTarget = null;
        updateBtn.style.display = 'none';
        submitBtn.style.display = 'block';

        // حفظ التغييرات
        saveToStorage(containerId);
        showNotification('تم تحديث البيانات بنجاح');
      } catch (error) {
        console.error('خطأ في تحديث البيانات:', error);
        showNotification('حدث خطأ في تحديث البيانات', 'error');
      }
    }

    function search(input, containerId) {
      const val = input.value.toLowerCase();
      document.querySelectorAll(`#${containerId} .entry`).forEach(entry => {
        entry.style.display = entry.innerText.toLowerCase().includes(val) ? "block" : "none";
      });
    }

    async function exportToJSON(containerId) {
      try {
        const entries = [];
        document.querySelectorAll(`#${containerId} .entry`).forEach(entry => {
          const data = {};
          entry.querySelectorAll('p').forEach(p => {
            const [key, ...rest] = p.innerText.split(':');
            data[key.trim()] = rest.join(':').trim();
          });
          entries.push(data);
        });

        const jsonString = JSON.stringify(entries, null, 2);
        
        try {
          // محاولة استخدام File System Access API
          const handle = await window.showSaveFilePicker({
            suggestedName: `${containerId}_export_${new Date().toISOString().slice(0,10)}.json`,
            types: [{
              description: 'JSON Files',
              accept: {
                'application/json': ['.json']
              }
            }]
          });
          
          const writable = await handle.createWritable();
          await writable.write(jsonString);
          await writable.close();
          
          showNotification('تم تصدير البيانات بنجاح');
        } catch (error) {
          // إذا فشل File System Access API، نستخدم الطريقة القديمة
          const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `${containerId}_export_${new Date().toISOString().slice(0,10)}.json`;
          document.body.appendChild(link);
          
          try {
            link.click();
          } catch (error) {
            const newWindow = window.open('', '_blank');
            newWindow.document.write(`
              <html dir="rtl">
              <head>
                <title>تصدير البيانات</title>
                <style>
                  body { font-family: Arial, sans-serif; padding: 20px; }
                  pre { white-space: pre-wrap; word-wrap: break-word; }
                  button { 
                    padding: 10px 20px; 
                    margin: 10px 0; 
                    background: #4CAF50; 
                    color: white; 
                    border: none; 
                    border-radius: 5px; 
                    cursor: pointer; 
                  }
                </style>
              </head>
              <body>
                <h2>بيانات التصدير</h2>
                <pre>${jsonString}</pre>
                <button onclick="navigator.clipboard.writeText(document.querySelector('pre').textContent)">نسخ البيانات</button>
                <p>يمكنك نسخ البيانات من الأعلى وحفظها في ملف JSON</p>
              </body>
              </html>
            `);
          }
          
          setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
          }, 100);
        }
      } catch (error) {
        console.error('خطأ في تصدير البيانات:', error);
        showNotification('حدث خطأ في تصدير البيانات', 'error');
      }
    }

    async function importJSON(event, containerId) {
      try {
        const [fileHandle] = await window.showOpenFilePicker({
          multiple: false,
          types: [{
            description: 'JSON Files',
            accept: {
              'application/json': ['.json']
            }
          }]
        });
        
        const file = await fileHandle.getFile();
        const content = await file.text();
        
        try {
          const data = JSON.parse(content);
          const container = document.getElementById(containerId);
          container.innerHTML = '';

          data.forEach((entry, index) => {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'entry';
            entryDiv.id = `${containerId}_entry_${index}`;

            for (let key in entry) {
              const p = document.createElement('p');
              p.innerHTML = `<b>${key}:</b> ${entry[key]}`;
              entryDiv.appendChild(p);
            }

            const controls = document.createElement('div');
            controls.className = 'controls';
            controls.innerHTML = `
              <button type="button" onclick="editEntry(this, '${containerId}')">تعديل</button>
              <button type="button" onclick="showDeleteConfirmation(this.closest('.entry'), '${containerId}')">حذف</button>
              <button type="button" onclick="copyEntry(this.closest('.entry'))">نسخ</button>
              <button type="button" onclick="sendToTelegram(this.closest('.entry'))" style="background: #0088cc !important;">إرسال تلجرام</button>
            `;
            entryDiv.appendChild(controls);
            container.appendChild(entryDiv);
          });

          saveToStorage(containerId);
          showNotification('تم استيراد البيانات بنجاح');
        } catch (error) {
          console.error('خطأ في استيراد البيانات:', error);
          showNotification('حدث خطأ في استيراد الملف. تأكد من صحة تنسيق JSON', 'error');
        }
      } catch (error) {
        // إذا فشل File System Access API، نستخدم الطريقة القديمة
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const data = JSON.parse(e.target.result);
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            data.forEach((entry, index) => {
              const entryDiv = document.createElement('div');
              entryDiv.className = 'entry';
              entryDiv.id = `${containerId}_entry_${index}`;

              for (let key in entry) {
                const p = document.createElement('p');
                p.innerHTML = `<b>${key}:</b> ${entry[key]}`;
                entryDiv.appendChild(p);
              }

              const controls = document.createElement('div');
              controls.className = 'controls';
              controls.innerHTML = `
                <button type="button" onclick="editEntry(this, '${containerId}')">تعديل</button>
                <button type="button" onclick="showDeleteConfirmation(this.closest('.entry'), '${containerId}')">حذف</button>
                <button type="button" onclick="copyEntry(this.closest('.entry'))">نسخ</button>
                <button type="button" onclick="sendToTelegram(this.closest('.entry'))" style="background: #0088cc !important;">إرسال تلجرام</button>
              `;
              entryDiv.appendChild(controls);
              container.appendChild(entryDiv);
            });

            saveToStorage(containerId);
            showNotification('تم استيراد البيانات بنجاح');
          } catch (error) {
            console.error('خطأ في استيراد البيانات:', error);
            showNotification('حدث خطأ في استيراد الملف. تأكد من صحة تنسيق JSON', 'error');
          }
        };
        reader.onerror = function() {
          showNotification('حدث خطأ في قراءة الملف', 'error');
        };
        reader.readAsText(file);
        event.target.value = '';
      }
    }

    function exportToCSV(containerId) {
      try {
        // جمع البيانات
        const entries = [];
        document.querySelectorAll(`#${containerId} .entry`).forEach(entry => {
          const data = {};
          entry.querySelectorAll('p').forEach(p => {
            const [key, ...rest] = p.innerText.split(':');
            data[key.trim()] = rest.join(':').trim();
          });
          entries.push(data);
        });

        if (entries.length === 0) {
          showNotification('لا توجد بيانات للتصدير', 'warning');
          return;
        }

        // إنشاء رأس CSV
        const headers = Object.keys(entries[0]);
        const csvContent = [
          headers.join(','),
          ...entries.map(entry => 
            headers.map(header => {
              const value = entry[header] || '';
              // معالجة القيم التي تحتوي على فواصل أو علامات اقتباس
              return `"${value.replace(/"/g, '""')}"`;
            }).join(',')
          )
        ].join('\n');

        // إنشاء ملف CSV
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        
        // استخدام طريقة متوافقة مع WebView
        const fileName = `${containerId}_export_${new Date().toISOString().slice(0,10)}.csv`;
        
        // محاولة استخدام Android Interface
        if (window.Android) {
          try {
            // طلب الصلاحيات أولاً
            window.Android.requestStoragePermission();
            
            // تحويل Blob إلى Base64
            const reader = new FileReader();
            reader.onload = function() {
              const base64 = reader.result.split(',')[1];
              // إضافة تأخير قصير للتأكد من حصول الصلاحيات
              setTimeout(() => {
                window.Android.saveFile(fileName, base64);
              }, 500);
            };
            reader.readAsDataURL(blob);
            return;
          } catch (e) {
            console.log('Android interface not available');
          }
        }
        
        // الطريقة البديلة
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
        
        showNotification('تم تصدير البيانات بنجاح');
      } catch (error) {
        console.error('خطأ في تصدير البيانات:', error);
        showNotification('حدث خطأ في تصدير البيانات', 'error');
      }
    }

    function importCSV(event, containerId) {
      const file = event.target.files[0];
      if (!file) return;

      // التحقق من نوع الملف
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showNotification('يرجى اختيار ملف CSV صالح', 'error');
        return;
      }

      // محاولة استخدام Android Interface
      if (window.Android) {
        try {
          window.Android.pickFile();
          return;
        } catch (e) {
          console.log('Android interface not available');
        }
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const content = e.target.result;
          const lines = content.split('\n');
          
          // قراءة الرأس
          const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
          
          // قراءة البيانات
          const entries = [];
          for (let i = 1; i < lines.length; i++) {
            if (!lines[i].trim()) continue;
            
            const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
            const entry = {};
            headers.forEach((header, index) => {
              entry[header] = values[index] || '';
            });
            entries.push(entry);
          }

          if (entries.length === 0) {
            showNotification('لم يتم العثور على بيانات في الملف', 'warning');
            return;
          }

          // تحديث واجهة المستخدم
          const container = document.getElementById(containerId);
          container.innerHTML = '';

          entries.forEach((entry, index) => {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'entry';
            entryDiv.id = `${containerId}_entry_${index}`;

            for (let key in entry) {
              const p = document.createElement('p');
              p.innerHTML = `<b>${key}:</b> ${entry[key]}`;
              entryDiv.appendChild(p);
            }

            const controls = document.createElement('div');
            controls.className = 'controls';
            controls.innerHTML = `
              <button type="button" onclick="editEntry(this, '${containerId}')">تعديل</button>
              <button type="button" onclick="showDeleteConfirmation(this.closest('.entry'), '${containerId}')">حذف</button>
              <button type="button" onclick="copyEntry(this.closest('.entry'))">نسخ</button>
              <button type="button" onclick="sendToTelegram(this.closest('.entry'))" style="background: #0088cc !important;">إرسال تلجرام</button>
            `;
            entryDiv.appendChild(controls);
            container.appendChild(entryDiv);
          });

          saveToStorage(containerId);
          showNotification(`تم استيراد ${entries.length} سجل بنجاح`);
        } catch (error) {
          console.error('خطأ في استيراد البيانات:', error);
          showNotification('حدث خطأ في استيراد الملف. تأكد من صحة تنسيق CSV', 'error');
        }
      };
      reader.onerror = function() {
        showNotification('حدث خطأ في قراءة الملف', 'error');
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    // دالة لاستقبال البيانات من Android
    function onFileSelected(content) {
      try {
        const lines = content.split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
        const entries = [];
        
        for (let i = 1; i < lines.length; i++) {
          if (!lines[i].trim()) continue;
          const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
          const entry = {};
          headers.forEach((header, index) => {
            entry[header] = values[index] || '';
          });
          entries.push(entry);
        }

        if (entries.length === 0) {
          showNotification('لم يتم العثور على بيانات في الملف', 'warning');
          return;
        }

        // تحديث واجهة المستخدم
        const container = document.getElementById('data1'); // أو أي containerId مناسب
        container.innerHTML = '';

        entries.forEach((entry, index) => {
          const entryDiv = document.createElement('div');
          entryDiv.className = 'entry';
          entryDiv.id = `data1_entry_${index}`;

          for (let key in entry) {
            const p = document.createElement('p');
            p.innerHTML = `<b>${key}:</b> ${entry[key]}`;
            entryDiv.appendChild(p);
          }

          const controls = document.createElement('div');
          controls.className = 'controls';
          controls.innerHTML = `
            <button type="button" onclick="editEntry(this, 'data1')">تعديل</button>
            <button type="button" onclick="showDeleteConfirmation(this.closest('.entry'), 'data1')">حذف</button>
            <button type="button" onclick="copyEntry(this.closest('.entry'))">نسخ</button>
            <button type="button" onclick="sendToTelegram(this.closest('.entry'))" style="background: #0088cc !important;">إرسال تلجرام</button>
          `;
          entryDiv.appendChild(controls);
          container.appendChild(entryDiv);
        });

        saveToStorage('data1');
        showNotification(`تم استيراد ${entries.length} سجل بنجاح`);
      } catch (error) {
        console.error('خطأ في استيراد البيانات:', error);
        showNotification('حدث خطأ في استيراد الملف', 'error');
      }
    }

    // طلب الصلاحيات عند تحميل الصفحة
    window.onload = () => {
      createInputs("data1");
      createInputs("data2");
      createInputs("data3");
      createInputs("data4");
      loadFromStorage("data1");
      loadFromStorage("data2");
      loadFromStorage("data3");
      loadFromStorage("data4");
    };
  </script>
</body>
</html>
